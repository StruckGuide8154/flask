<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <style>
        :root {
            --black: #08080a;
            --gold: #ffd70080;
            --gold-bright: #ffd700;
            --gold-glow: rgba(255, 215, 0, 0.08);
            --gold-gradient: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 179, 71, 0.9));
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --bg-surface: rgba(8, 8, 10, 0.85);
            --border: rgba(255, 215, 0, 0.08);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif;
        }

        body {
            background: var(--black);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
            background-image: 
                radial-gradient(circle at 20% 20%, var(--gold-glow) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--gold-glow) 0%, transparent 50%);
        }

        .app {
            display: grid;
            grid-template-columns: 240px 1fr;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }

        .login {
            position: fixed;
            inset: 0;
            background: var(--black);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .login-form {
            background: var(--bg-surface);
            padding: 2.5rem;
            border-radius: 1.5rem;
            border: 1px solid var(--border);
            width: 90%;
            max-width: 400px;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 2rem;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px var(--gold-glow);
            letter-spacing: -0.02em;
        }

        .input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            color: var(--text);
            margin-bottom: 1rem;
            font-size: 0.9375rem;
            transition: all 0.2s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 1px var(--gold), 0 0 20px var(--gold-glow);
        }

        .btn {
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 500;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--gold-gradient);
            color: var(--black);
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .sidebar {
            background: var(--bg-surface);
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-right: 0.5rem;
        }

        .chat-item {
            padding: 0.75rem 0.875rem;
            border-radius: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item:hover {
            border-color: var(--gold);
            color: var(--text);
            transform: translateX(2px);
        }

        .chat-item.active {
            background: var(--gold-gradient);
            border: none;
            color: var(--black);
        }

        .main {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-surface);
            backdrop-filter: blur(20px);
        }

        .header {
            padding: 0.875rem 1.25rem;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
            backdrop-filter: blur(20px);
        }

        .model-select {
            padding: 0.5rem 0.875rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            color: var(--text);
            font-size: 0.875rem;
            outline: none;
            min-width: 160px;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .message-group {
            display: flex;
            gap: 1rem;
            padding: 0.5rem;
            animation: slideIn 0.3s ease;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gold-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message-avatar.ai {
            background: var(--bg-surface);
            border: 1px solid var(--border);
        }

        .message-content {
            flex: 1;
            max-width: 80%;
        }

        .message {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            line-height: 1.6;
            font-size: 0.9375rem;
            box-shadow: var(--shadow);
            display: inline-block;
            max-width: 100%;
        }

        .message.user {
            background: var(--gold-gradient);
            color: var(--black);
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .message.ai {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-bottom-left-radius: 0.25rem;
        }

        .message img {
            max-width: 100%;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
        }

        .message pre {
            background: rgba(0, 0, 0, 0.3) !important;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 0.5rem 0;
            overflow-x: auto;
        }

        .input-area {
            padding: 1rem 1.25rem;
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            backdrop-filter: blur(20px);
        }

        .input-wrap {
            display: flex;
            gap: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 0.75rem;
            transition: all 0.2s ease;
        }

        .input-wrap:focus-within {
            border-color: var(--gold);
            box-shadow: 0 0 0 1px var(--gold), 0 0 20px var(--gold-glow);
        }

        .chat-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text);
            font-size: 0.9375rem;
            outline: none;
            resize: none;
            min-height: 24px;
            padding: 0.25rem;
            line-height: 1.5;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            padding: 0.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
        }

        .action-btn:hover {
            color: var(--gold-bright);
            background: var(--gold-glow);
        }

        .file-preview {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem 0;
            flex-wrap: wrap;
        }

        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .preview-item:hover {
            border-color: var(--gold);
            transform: scale(1.02);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s ease;
        }

        .remove-file {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
            backdrop-filter: blur(4px);
            transition: all 0.2s ease;
        }

        .remove-file:hover {
            background: rgba(255, 0, 0, 0.3);
            border-color: rgba(255, 0, 0, 0.5);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 1rem;
            color: var(--text-dim);
            text-align: center;
            padding: 2rem;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            stroke: var(--gold);
            opacity: 0.5;
        }

        .empty-state h3 {
            font-weight: 500;
            color: var(--text);
        }

        .empty-state p {
            font-size: 0.875rem;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gold);
        }
        .credits-display {
    position: fixed;
    top: 1rem;
    right: 1rem;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    padding: 0.5rem 1rem;
    border-radius: 0.75rem;
    font-size: 0.875rem;
    color: var(--gold);
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
    z-index: 100;
}

.message-cost {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-top: 0.25rem;
    opacity: 0.8;
}

    </style>
</head>
<body>
    <div class="login" id="loginScreen">
        <div class="login-form">
            <div class="logo">AI Chat</div>
            <input type="text" class="input" id="username" placeholder="Username">
            <input type="password" class="input" id="password" placeholder="Password">
            <button class="btn" id="loginBtn">Sign In</button>
        </div>
    </div>

    <div class="app" id="app" style="display: none;">
        <aside class="sidebar">
            <div class="logo">AI Chat</div>
            <button class="btn" id="newChatBtn">New Chat</button>
            <div class="chat-list" id="chatList"></div>
        </aside>

        <main class="main">
            <div class="header">
                <select class="model-select" id="modelSelect">
                    <option value="claude-opus">Claude 3 Opus</option>
                    <option value="claude-sonnet">Claude 3 Sonnet</option>
                    <option value="claude-haiku">Claude 3 Haiku</option>
                    <option value="gpt4-vision">GPT-4 Vision</option>
                </select>
            </div>
<div class="credits-display">
    Credits: <span id="creditsAmount">0.00</span>
</div>


            <div class="messages" id="messages">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <h3>Start a New Conversation</h3>
                    <p>Type a message below to begin chatting</p>
                </div>
            </div>

            <div class="input-area">
                <div class="input-wrap">
                    <textarea 
                        class="chat-input" 
                        id="messageInput" 
                        placeholder="Message (Markdown & Code supported)" 
                        rows="1"
                    ></textarea>
                    
                    <button class="action-btn upload-btn" id="uploadBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242M12 12v9m4-4-4-4-4 4"/>
                        </svg>
                    </button>
                    <input type="file" id="fileInput" hidden multiple accept="image/*,.pdf,.txt">
                    
                    <button class="action-btn send-btn" id="sendBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2 11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                    </button>
                </div>
                <div class="file-preview" id="filePreview"></div>
            </div>
        </main>
    </div>

    <script>
// Global state
// Global state
let token = null;
let currentChatId = null;
let messageHistory = [];
let uploadedFiles = [];
let user = null;

// Configure markdown
marked.setOptions({
    highlight: (code, lang) => hljs.highlightAuto(code).value,
    breaks: true
});

// Initialize event listeners
document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    checkSavedToken();
});

function setupEventListeners() {
    // Login handling
    document.getElementById('loginBtn')?.addEventListener('click', login);
    document.getElementById('password')?.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            login();
        }
    });

    // Chat interface
    document.getElementById('newChatBtn')?.addEventListener('click', startNewChat);
    document.getElementById('uploadBtn')?.addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });
    document.getElementById('sendBtn')?.addEventListener('click', sendMessage);

    // File handling
    document.getElementById('fileInput')?.addEventListener('change', handleFileUpload);

    // Message input
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
        });
        messageInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    // Logout shortcut
    document.addEventListener('keydown', e => {
        if (e.key === 'l' && (e.metaKey || e.ctrlKey)) {
            e.preventDefault();
            logout();
        }
    });
}

function checkSavedToken() {
    const savedToken = localStorage.getItem('token');
    if (savedToken) {
        token = savedToken;
        verifyAndInitialize();
    }
}

// Auth functions
async function login() {
    try {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        if (!username || !password) {
            alert('Please enter both username and password');
            return;
        }

        const response = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        if (response.ok) {
            const data = await response.json();
            token = data.token;
            user = data.user;
            localStorage.setItem('token', token);
            showApp();
            updateCreditsDisplay(user.credits);
            await initializeApp();
        } else {
            throw new Error('Login failed');
        }
    } catch (error) {
        console.error('Login error:', error);
        alert('Login failed. Please check your credentials and try again.');
    }
}

async function verifyAndInitialize() {
    try {
        const response = await fetch('/api/verify', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            showApp();
            await initializeApp();
        } else {
            throw new Error('Invalid token');
        }
    } catch (error) {
        console.error('Verification error:', error);
        logout();
    }
}

function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').style.display = 'grid';
}

function logout() {
    localStorage.removeItem('token');
    window.location.reload();
}

function updateCreditsDisplay(credits) {
    const display = document.getElementById('creditsAmount');
    if (display) {
        display.textContent = (credits || 0).toFixed(2);
    }
}

// App initialization
async function initializeApp() {
    try {
        await loadChats();
        if (currentChatId) {
            await loadChat(currentChatId);
        }
    } catch (error) {
        console.error('Initialization error:', error);
        alert('Failed to initialize the application. Please try refreshing the page.');
    }
}

// Chat management
async function loadChats() {
    try {
        const response = await fetch('/api/chats', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to load chats');
        
        const chats = await response.json();
        const chatList = document.getElementById('chatList');
        if (!chatList) return;
        
        chatList.innerHTML = '';
        
        chats.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
             .forEach(chat => {
                const item = document.createElement('div');
                item.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                
                const title = chat.messages?.[0]?.content?.text || chat.messages?.[0]?.content || 'New Chat';
                const displayTitle = title.substring(0, 25) + (title.length > 25 ? '...' : '');
                
                item.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>${displayTitle}</span>
                `;
                
                item.dataset.chatId = chat.id;
                item.addEventListener('click', () => loadChat(chat.id));
                chatList.appendChild(item);
             });
    } catch (error) {
        console.error('Failed to load chats:', error);
    }
}

async function startNewChat() {
    try {
        const response = await fetch('/api/chats', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error('Failed to create chat');
        
        const chat = await response.json();
        currentChatId = chat.id;
        messageHistory = [];
        
        showEmptyState();
        await loadChats();
        return chat;
    } catch (error) {
        console.error('Failed to start new chat:', error);
        alert('Failed to create new chat. Please try again.');
        throw error;
    }
}

function showEmptyState() {
    const messagesContainer = document.getElementById('messages');
    if (messagesContainer) {
        messagesContainer.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <h3>Start a New Conversation</h3>
                <p>Type a message below to begin chatting</p>
            </div>
        `;
    }
}

async function loadChat(chatId) {
    try {
        const response = await fetch('/api/chats', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to load chats');
        
        const chats = await response.json();
        const chat = chats.find(c => c.id === chatId);
        
        if (!chat) throw new Error('Chat not found');
        
        currentChatId = chatId;
        messageHistory = chat.messages || [];
        
        const messagesContainer = document.getElementById('messages');
        if (!messagesContainer) return;
        
        messagesContainer.innerHTML = '';
        
        if (messageHistory.length) {
            messageHistory.forEach(msg => {
                if (typeof msg.content === 'object') {
                    appendMessage(msg.content.text || '', msg.role === 'user', msg.cost, msg.content.files);
                } else {
                    appendMessage(msg.content, msg.role === 'user', msg.cost);
                }
            });
        } else {
            showEmptyState();
        }
        
        updateActiveChatSelection(chatId);
    } catch (error) {
        console.error('Failed to load chat:', error);
    }
}

function updateActiveChatSelection(chatId) {
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.toggle('active', item.dataset.chatId === chatId);
    });
}

// File handling
async function handleFileUpload(event) {
    const files = event.target.files;
    if (!files.length) return;

    const maxSize = 5 * 1024 * 1024; // 5MB limit
    const formData = new FormData();
    let oversizedFiles = [];

    for (let file of files) {
        if (file.size > maxSize) {
            oversizedFiles.push(file.name);
            continue;
        }
        formData.append('files', file);
    }

    if (oversizedFiles.length) {
        alert(`Some files exceed the 5MB limit: ${oversizedFiles.join(', ')}`);
    }

    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });

        if (!response.ok) throw new Error('Upload failed');

        const result = await response.json();
        uploadedFiles = uploadedFiles.concat(result);
        updateFilePreview();
    } catch (error) {
        console.error('File upload failed:', error);
        alert('Failed to upload files. Please try again.');
    }

    event.target.value = '';
}

function updateFilePreview() {
    const preview = document.getElementById('filePreview');
    if (!preview) return;
    preview.innerHTML = '';

    uploadedFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'preview-item';
        
        if (file.type === 'image') {
            item.innerHTML = `
                <img src="${file.base64}" alt="Preview">
                <button class="remove-file" onclick="removeFile(${index})">&times;</button>
            `;
        } else {
            item.innerHTML = `
                <div style="padding: 1rem; text-align: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                        <polyline points="13 2 13 9 20 9"/>
                    </svg>
                    <div style="font-size: 0.75rem; margin-top: 0.5rem;">${file.name}</div>
                </div>
                <button class="remove-file" onclick="removeFile(${index})">&times;</button>
            `;
        }
        preview.appendChild(item);
    });
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    updateFilePreview();
}

// Message handling
function appendMessage(content, isUser, cost = null, files = []) {
    const messages = document.getElementById('messages');
    if (!messages) return;
    
    const emptyState = messages.querySelector('.empty-state');
    if (emptyState) {
        messages.removeChild(emptyState);
    }
    
    const messageGroup = document.createElement('div');
    messageGroup.className = 'message-group';
    
    const avatar = document.createElement('div');
    avatar.className = `message-avatar ${isUser ? 'user' : 'ai'}`;
    avatar.innerHTML = isUser ? 
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>' : 
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8V4m0 4 3 3m-3-3-3 3m3 3v4m0 0-3-3m3 3 3-3"/></svg>';
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;

    if (isUser) {
        let finalContent = '';
        
        if (files && files.length > 0) {
            const filesHtml = files.map(file => {
                if (file.type === 'image') {
                    return `<img src="${file.base64}" alt="Upload" style="max-width: 200px; border-radius: 0.5rem; margin: 0.5rem 0;">`;
                }
                return `<div>[File: ${file.name}]</div>`;
            }).join('');
            finalContent += filesHtml;
        }
        
        if (content) {
            finalContent += `<div>${content}</div>`;
        }
        
        messageDiv.innerHTML = finalContent;
    } else {
        try {
            messageDiv.innerHTML = marked.parse(content);
            messageDiv.querySelectorAll('pre code').forEach(block => {
                hljs.highlightBlock(block);
            });
        } catch (error) {
            console.error('Markdown parsing error:', error);
            messageDiv.textContent = content;
        }
    }

    messageContent.appendChild(messageDiv);

    if (!isUser && cost) {
        const costDisplay = document.createElement('div');
        costDisplay.className = 'message-cost';
        costDisplay.textContent = `Credits used: ${cost.toFixed(4)}`;
        messageContent.appendChild(costDisplay);
    }
    
    if (isUser) {
        messageGroup.appendChild(messageContent);
        messageGroup.appendChild(avatar);
    } else {
        messageGroup.appendChild(avatar);
        messageGroup.appendChild(messageContent);
    }
    
    messages.appendChild(messageGroup);
    messages.scrollTop = messages.scrollHeight;
}

function updateLastMessage(content, cost = null) {
    const messages = document.getElementById('messages');
    if (!messages) return;
    
    const lastMessage = messages.lastElementChild;
    
    if (lastMessage?.querySelector('.message.ai')) {
        const messageDiv = lastMessage.querySelector('.message.ai');
        try {
            messageDiv.innerHTML = marked.parse(content);
            messageDiv.querySelectorAll('pre code').forEach(block => {
                hljs.highlightBlock(block);
            });

            if (cost) {
                let costDisplay = lastMessage.querySelector('.message-cost');
                if (!costDisplay) {
                    costDisplay = document.createElement('div');
                    costDisplay.className = 'message-cost';
                    lastMessage.querySelector('.message-content').appendChild(costDisplay);
                }
                costDisplay.textContent = `Credits used: ${cost.toFixed(4)}`;
            }
        } catch (error) {
            console.error('Markdown parsing error:', error);
            messageDiv.textContent = content;
        }
        messages.scrollTop = messages.scrollHeight;
    } else {
        appendMessage(content, false, cost);
    }
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    if (!input) return;
    
    const message = input.value.trim();
    if (!message && !uploadedFiles.length) return;
    
    try {
        if (!currentChatId) {
            const newChat = await startNewChat();
            if (!newChat) return;
        }

        appendMessage(message, true, null, uploadedFiles);
        input.value = '';
        input.style.height = 'auto';

        // Format the message history correctly
        const formattedHistory = messageHistory.map(msg => ({
            role: msg.role === 'user' ? 'user' : 'assistant',
            content: typeof msg.content === 'object' ? msg.content.text : msg.content
        }));

        const response = await fetch('/api/chat/stream', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chatId: currentChatId,
                message: message,
                files: uploadedFiles,
                model: document.getElementById('modelSelect').value,
                history: formattedHistory,
                system: "You are an AI assistant that helps with text and images. Provide clear, helpful responses."
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error:', errorText);
            throw new Error('Failed to send message');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let currentResponse = '';
        let messageCost = null;

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(5));
                        if (data.type === 'cost') {
                            messageCost = data.cost;
                            if (user?.credits !== undefined) {
                                user.credits -= data.cost;
                                updateCreditsDisplay(user.credits);
                            }
                        } else if (data.content) {
                            currentResponse += data.content;
                            updateLastMessage(currentResponse, messageCost);
                        }
                    } catch (e) {
                        console.error('Error parsing stream:', e);
                        console.log('Problematic line:', line);
                    }
                }
            }
        }

        // Store message in history with proper format
        messageHistory.push(
            { 
                role: 'user', 
                content: uploadedFiles.length ? {
                    text: message,
                    files: uploadedFiles
                } : message
            },
            { 
                role: 'assistant', 
                content: currentResponse,
                cost: messageCost 
            }
        );

        // Save chat to backend
        await fetch(`/api/chats/${currentChatId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: messageHistory
            })
        });

        uploadedFiles = [];
        updateFilePreview();
        await loadChats();

    } catch (error) {
        console.error('Failed to send message:', error);
        alert('Failed to send message. Please try again.');
    }
}
    </script>
</body>
</html>
